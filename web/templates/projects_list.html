<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–µ–∫—Ç—ã</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<header class="topbar">
    <div class="logo">IB Integrator</div>

    <nav>
        <a href="/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
        <a href="/assets">–û–±—ä–µ–∫—Ç—ã –∑–∞—â–∏—Ç—ã</a>
        <a href="/projects">–ü—Ä–æ–µ–∫—Ç—ã</a>
        {{ if and .CurrentUser (eq .CurrentUser.Role "admin") }}
            <a href="/audit">–ê—É–¥–∏—Ç</a>
        {{ end }}
        <a href="/logout">–í—ã—Ö–æ–¥</a>
    </nav>

    <div class="user-info">
        {{ if .CurrentUser }}
            üë§ {{ .CurrentUser.Username }} ({{ .CurrentUser.Role }})
        {{ end }}
    </div>
</header>


<main class="content">
    <h2>–ü—Ä–æ–µ–∫—Ç—ã –ø–æ –ò–ë</h2>

    <div class="toolbar">
        {{ if or $.IsAdmin $.IsSales }}
            <a class="btn" href="/projects/new">+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</a>
        {{ end }}
    </div>

    <form method="get" action="/projects" class="filters">

        <label>–ö–ª–∏–µ–Ω—Ç
            <select name="client_id">
                <option value="">–í—Å–µ</option>
                {{ range .clients }}
                    <option value="{{ .ID }}" {{ if eq $.FilterClientID (printf "%d" .ID) }}selected{{ end }}>
                        {{ .Name }}
                    </option>
                {{ end }}
            </select>
        </label>

        <label>–¢–∏–ø
            <select name="type">
                <option value="">–í—Å–µ</option>
                <option value="audit"       {{ if eq .FilterType "audit" }}selected{{ end }}>–ê—É–¥–∏—Ç</option>
                <option value="szi_deploy"  {{ if eq .FilterType "szi_deploy" }}selected{{ end }}>–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –°–ó–ò</option>
                <option value="pentest"     {{ if eq .FilterType "pentest" }}selected{{ end }}>–ü–µ–Ω—Ç–µ—Å—Ç</option>
                <option value="maintenance" {{ if eq .FilterType "maintenance" }}selected{{ end }}>–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</option>
                <option value="compliance"  {{ if eq .FilterType "compliance" }}selected{{ end }}>–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</option>
            </select>
        </label>

        <label>–°—Ç–∞—Ç—É—Å
            <select name="status">
                <option value="">–í—Å–µ</option>
                <option value="planned"     {{ if eq .FilterStatus "planned" }}selected{{ end }}>–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è</option>
                <option value="in_progress" {{ if eq .FilterStatus "in_progress" }}selected{{ end }}>–≤ —Ä–∞–±–æ—Ç–µ</option>
                <option value="on_approval" {{ if eq .FilterStatus "on_approval" }}selected{{ end }}>–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
                <option value="finished"    {{ if eq .FilterStatus "finished" }}selected{{ end }}>–∑–∞–≤–µ—Ä—à—ë–Ω</option>
                <option value="cancelled"   {{ if eq .FilterStatus "cancelled" }}selected{{ end }}>–æ—Ç–º–µ–Ω—ë–Ω</option>
            </select>
        </label>

        <button type="submit" class="btn">–§–∏–ª—å—Ç—Ä</button>
        <a href="/projects" class="btn secondary">–°–±—Ä–æ—Å</a>
    </form>

    <table class="table">
        <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–ö–ª–∏–µ–Ω—Ç</th>
            <th>–û–±—ä–µ–∫—Ç –∑–∞—â–∏—Ç—ã</th>
            <th>–¢–∏–ø</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ü–ª–∞–Ω. –¥–∞—Ç—ã</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>

        <tbody>
        {{ range .projects }}

            <tr>
                <td>{{ .Title }}</td>
                <td>{{ if .Client }}{{ .Client.Name }}{{ end }}</td>
                <td>{{ if .Asset }}{{ .Asset.Name }}{{ end }}</td>
                <td>{{ .Type }}</td>
                <td>{{ .Status }}</td>
                <td>
                    {{ if .PlannedStart }}—Å {{ .PlannedStart.Format "2006-01-02" }}{{ end }}
                    {{ if .PlannedEnd }} –ø–æ {{ .PlannedEnd.Format "2006-01-02" }}{{ end }}
                </td>

                <td>
                    <div class="actions">

                        <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –ò–°–¢–û–†–ò–Ø -->
                        <a class="btn small" href="/projects/{{ .ID }}/history">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>

                        <!-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å -->
                        {{ if $.IsAdmin }}
                            <a class="btn small secondary" href="/projects/{{ .ID }}/edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

                            <form method="post" action="/projects/{{ .ID }}/delete"
                                  style="display:inline-block"
                                  onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç {{ .Title }}?');">
                                <button type="submit" class="btn small danger">–£–¥–∞–ª–∏—Ç—å</button>
                            </form>
                        {{ end }}

                        <!-- –õ–û–ì–ò–ö–ê –°–¢–ê–¢–£–°–û–í -->
                        {{ if or $.IsAdmin $.IsSales $.IsEngineer }}

                            {{ if eq (printf "%s" .Status) "planned" }}
                                {{ if or $.IsAdmin $.IsSales }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button class="btn small">–í —Ä–∞–±–æ—Ç—É</button>
                                    </form>
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button class="btn small secondary">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                    </form>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "in_progress" }}
                                {{ if or $.IsAdmin $.IsEngineer }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="on_approval">
                                        <button class="btn small">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</button>
                                    </form>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "on_approval" }}
                                {{ if $.IsAdmin }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button class="btn small secondary">–ù–∞–∑–∞–¥ –≤ —Ä–∞–±–æ—Ç—É</button>
                                    </form>

                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="finished">
                                        <button class="btn small">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                                    </form>

                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button class="btn small secondary">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                    </form>

                                {{ else if $.IsSales }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button class="btn small secondary">–ù–∞–∑–∞–¥ –≤ —Ä–∞–±–æ—Ç—É</button>
                                    </form>

                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button class="btn small secondary">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                    </form>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "finished" }}
                                {{ if $.IsAdmin }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button class="btn small secondary">–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
                                    </form>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "cancelled" }}
                                {{ if $.IsAdmin }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="planned">
                                        <button class="btn small secondary">–í–µ—Ä–Ω—É—Ç—å –≤ –ø–ª–∞–Ω</button>
                                    </form>
                                {{ end }}

                            {{ else }}
                                <span class="muted">–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π</span>
                            {{ end }}

                        {{ else }}
                            <span class="muted">–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π</span>
                        {{ end }}

                    </div>
                </td>
            </tr>

        {{ else }}
        <tr><td colspan="7">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</td></tr>
        {{ end }}
        </tbody>
    </table>

</main>

</body>
</html>
