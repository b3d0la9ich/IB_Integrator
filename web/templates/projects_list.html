<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Проекты</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header class="topbar">
    <div class="logo">IB Integrator</div>
    <nav>
        <a href="/clients">Клиенты</a>
        <a href="/assets">Объекты защиты</a>
        <a href="/projects">Проекты</a>
        <a href="/audit">Аудит</a>
        <a href="/logout">Выход</a>
    </nav>
</header>

<main class="content">
    <h2>Проекты по ИБ</h2>

    <div class="toolbar">
        {{ if or $.IsAdmin $.IsSales }}
            <a class="btn" href="/projects/new">+ Новый проект</a>
        {{ end }}
    </div>

    <form method="get" action="/projects" class="filters">
        <label>Клиент
            <select name="client_id">
                <option value="">Все</option>
                {{ range .clients }}
                    <option value="{{ .ID }}"
                        {{ if eq $.FilterClientID (printf "%d" .ID) }}selected{{ end }}>
                        {{ .Name }}
                    </option>
                {{ end }}
            </select>
        </label>

        <label>Тип
            <select name="type">
                <option value="">Все</option>
                <option value="audit"       {{ if eq .FilterType "audit" }}selected{{ end }}>Аудит</option>
                <option value="szi_deploy"  {{ if eq .FilterType "szi_deploy" }}selected{{ end }}>Внедрение СЗИ</option>
                <option value="pentest"     {{ if eq .FilterType "pentest" }}selected{{ end }}>Пентест</option>
                <option value="maintenance" {{ if eq .FilterType "maintenance" }}selected{{ end }}>Сопровождение</option>
                <option value="compliance"  {{ if eq .FilterType "compliance" }}selected{{ end }}>Соответствие</option>
            </select>
        </label>

        <label>Статус
            <select name="status">
                <option value="">Все</option>
                <option value="planned"     {{ if eq .FilterStatus "planned" }}selected{{ end }}>планируется</option>
                <option value="in_progress" {{ if eq .FilterStatus "in_progress" }}selected{{ end }}>в работе</option>
                <option value="on_approval" {{ if eq .FilterStatus "on_approval" }}selected{{ end }}>на согласовании</option>
                <option value="finished"    {{ if eq .FilterStatus "finished" }}selected{{ end }}>завершён</option>
                <option value="cancelled"   {{ if eq .FilterStatus "cancelled" }}selected{{ end }}>отменён</option>
            </select>
        </label>

        <button type="submit" class="btn">Фильтр</button>
        <a href="/projects" class="btn secondary">Сброс</a>
    </form>

    <table class="table">
        <thead>
        <tr>
            <th>Название</th>
            <th>Клиент</th>
            <th>Объект защиты</th>
            <th>Тип</th>
            <th>Статус</th>
            <th>План. даты</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        {{ range .projects }}
            <tr>
                <td>{{ .Title }}</td>
                <td>{{ if .Client }}{{ .Client.Name }}{{ end }}</td>
                <td>{{ if .Asset }}{{ .Asset.Name }}{{ end }}</td>
                <td>{{ .Type }}</td>
                <td>{{ .Status }}</td>
                <td>
                    {{ if .PlannedStart }}с {{ .PlannedStart.Format "2006-01-02" }}{{ end }}
                    {{ if .PlannedEnd }} по {{ .PlannedEnd.Format "2006-01-02" }}{{ end }}
                </td>
                <td>
                    {{ if or $.IsAdmin $.IsSales $.IsEngineer }}
                        <div class="actions">
                            {{ if eq (printf "%s" .Status) "planned" }}
                                {{ if or $.IsAdmin $.IsSales }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button type="submit" class="btn small">В работу</button>
                                    </form>
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button type="submit" class="btn small secondary">Отменить</button>
                                    </form>
                                {{ else }}
                                    <span class="muted">Нет действий</span>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "in_progress" }}
                                {{ if or $.IsAdmin $.IsEngineer }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="on_approval">
                                        <button type="submit" class="btn small">На согласование</button>
                                    </form>
                                {{ else }}
                                    <span class="muted">Нет действий</span>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "on_approval" }}
                                {{ if $.IsAdmin }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button type="submit" class="btn small secondary">Назад в работу</button>
                                    </form>
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="finished">
                                        <button type="submit" class="btn small">Завершить</button>
                                    </form>
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button type="submit" class="btn small secondary">Отменить</button>
                                    </form>
                                {{ else if $.IsSales }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button type="submit" class="btn small secondary">Назад в работу</button>
                                    </form>
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="cancelled">
                                        <button type="submit" class="btn small secondary">Отменить</button>
                                    </form>
                                {{ else }}
                                    <span class="muted">Нет действий</span>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "finished" }}
                                {{ if $.IsAdmin }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="in_progress">
                                        <button type="submit" class="btn small secondary">Вернуть в работу</button>
                                    </form>
                                {{ else }}
                                    <span class="muted">Нет действий</span>
                                {{ end }}

                            {{ else if eq (printf "%s" .Status) "cancelled" }}
                                {{ if $.IsAdmin }}
                                    <form method="post" action="/projects/{{ .ID }}/status">
                                        <input type="hidden" name="status" value="planned">
                                        <button type="submit" class="btn small secondary">Вернуть в план</button>
                                    </form>
                                {{ else }}
                                    <span class="muted">Нет действий</span>
                                {{ end }}

                            {{ else }}
                                <span class="muted">Нет действий</span>
                            {{ end }}
                        </div>
                    {{ else }}
                        <span class="muted">Нет действий</span>
                    {{ end }}
                </td>
            </tr>
        {{ else }}
            <tr><td colspan="7">Нет проектов</td></tr>
        {{ end }}
        </tbody>
    </table>
</main>
</body>
</html>
